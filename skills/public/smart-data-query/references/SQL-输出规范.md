# SQL 输出规范（用于“人工执行导出”）

## 必须满足

- **可直接执行**：输出一段完整 SQL（允许 CTE），不输出伪代码。
- **参数清晰**：用占位符表示可变参数（例如 `{{start_date}}`、`{{end_date}}`、`{{dt}}`），并在注释中说明格式。
- **字段命名一致**：输出字段与需求字段一一对应，能对账。
- **过滤条件显式**：时间范围、业务过滤、去重规则都要写清楚。
- **分区可下推**：尽量用事实表分区字段（如 `dt/ds/biz_date`）做过滤，避免全表扫描。
- **默认方言明确**：默认输出 Hive/SparkSQL；若用户要求 GaussDB，需给出单独版本并说明差异/注意点。

## 推荐结构

1. `base`：从事实表取数（只选必要列 + 分区过滤 + 业务过滤）
2. `agg`：聚合口径（按需求粒度 group by）
3. `dim_*`：维度补充（必要时先去重/取最新）
4. `final`：整理输出字段、排序、limit/topN

## 推荐写法

- 统一使用显式字段列表（避免 `select *`）。
- join 时写清楚 join 类型与 join key；必要时在注释里说明“是否可能放大”。
- 对日期/时间函数使用与方言匹配的写法（不确定时先问用户）。
- 对维表/映射表：若存在多版本/多行风险，先在 CTE 中去重/取最新再 join（避免多对多放大）。
- 低版本 Hive 兼容性：避免在 `SELECT` 列表或 `JOIN ... ON` 中写子查询表达式（形如 `(select ...)`），优先用派生表/CTE 先算好再 `JOIN`。
- Hive 兼容性：`ORDER BY` 尽量只用最终输出列（必要时把排序字段也输出为辅助列，或改用 `ORDER BY` 位置序号），避免部分版本报 `Invalid table alias or column reference`。
