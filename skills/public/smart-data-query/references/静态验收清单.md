# 静态验收清单（不连库也要做）

目的：在无法实际执行 SQL 的情况下，尽量提前暴露“选表/粒度/口径/可执行性”风险。

## 选表与粒度

- 明确最终输出粒度（例如：天-用户、天-门店、订单、订单行）。
- 优先 ADS：若已包含目标指标/维度（或仅需轻量过滤/排序），直接出数。
- 若用 DWS/DWT：
  - 指标是否已在 ETL 字段中定义？能用就不要重算。
  - 是否需要二次聚合？`group by` 键是否与目标粒度一致？
- ETL 去重信号：
  - 存在 `row_number() over (partition by ...)`：确认 partition by 列就是去重键/拉链键，并确认取最新规则（order by）。
  - 存在 `select distinct`：确认不是“用 distinct 掩盖多对多放大”。

## Join 放大风险（重点）

- 每个 join 都写清 join key；确认 key 类型/口径一致。
- 维表/映射表是否存在多版本/多行？如是：
  - 先对维表去重/取最新（例如 `row_number()`）再 join。
- 避免事实表与多行维表直接 join 后再聚合（容易放大）。

## 分区/时间过滤（重点）

- 找到事实表分区字段（常见 `dt/ds/biz_date`），并在最早的事实表 CTE 中用它过滤（下推）。
- 明确时间范围边界（是否包含当天、是否按自然日、时区）。

## SQL 可执行与可验收

- 禁用 `select *`：显式列出输出字段，别名与需求字段一一对应。
- `group by` 与选择列一致；聚合指标不重复计算。
- 默认 Hive/SparkSQL 方言；仅当用户明确要求才补充 GaussDB 版本（并提示需要试跑确认）。
- Hive 低版本兼容：不要在 `SELECT` 列表或 `JOIN ... ON` 里写 `(select ...)` 子查询表达式；改为先聚合/去重生成派生表再 join。
- Hive 兼容：`order by` 字段是否出现在最终输出列？（部分 Hive 版本要求如此，否则报 `Invalid table alias or column reference`）

## 工具（可选）

- `scripts/check_query.py`：对生成的 SQL 输出启发式警告（如缺少分区过滤、select *、join 过多等）。
