# 分层与选表指南（ADS / DWS / DWT）

目标：在只拿到“需求 + 数仓目录(表设计文档+SQL)”且不直连数据库的情况下，快速定位合适的表与口径，并逐步加载最少文件完成最终查询 SQL。

## 选表优先级

1. **优先 ADS**
   - ADS 往往是面向报表/应用的结果层：字段更贴近业务语义，聚合与口径更稳定。
   - 若 ADS 已包含目标指标与维度（或仅需轻量过滤/排序），直接用 ADS 出数。
2. **其次 DWS**
   - DWS 常承载公共汇总/服务层：适合二次聚合、拼维度、做口径调整。
   - 需求是“多个指标、多维分析、按天/按组织/按渠道”等，通常从 DWS 更稳。
3. **再到 DWT**
   - DWT 常是主题宽表或明细宽表：字段多、口径更原子，适合需要自定义口径、复杂过滤、补充明细字段的场景。
   - 但扫描代价可能更大，需要更严格的分区/过滤与字段选择。

## “匹配度”判断（读 SQL(DDL+ETL) 时重点看什么）

1. **粒度（grain）**
   - 表是一行代表什么：天-用户？订单？订单明细行？事件？门店-天？账号-月？
   - 粒度不一致会导致指标放大/重复计算，是最常见坑。
2. **时间字段与分区**
   - 是否存在分区字段（如 `dt`/`ds`/`biz_date`），ETL 是否按它分区写入。
   - 最终 SQL 要尽量用分区字段做过滤（下推）。
3. **口径来源**
   - 指标是否已经在 ETL 中计算（如 GMV/支付金额/活跃用户），还是需要你从明细自算。
   - 是否有“有效订单/剔除退款/去重规则/取最新状态”等逻辑。
4. **主键/维度键**
   - join key 是否稳定：`user_id`、`shop_id`、`order_id`、`sku_id`、`org_id` 等。
   - 是否需要映射表（渠道、地区、组织、类目等）。
5. **从 ETL 快速抽“信号”来判断粒度/去重（推荐先看，再精读）**
   - 是否存在 `group by`：通常意味着表已经按某些键聚合（这些键往往就是事实粒度线索）。
   - 是否存在 `row_number() over (partition by ...)`：常见于拉链取最新/去重；`partition by` 列可以作为“去重键”线索。
   - 是否存在 `select distinct`：可能在做去重（但也可能掩盖上游多对多问题）。
   - 是否存在明确的分区写入：`insert overwrite ... partition (...)`，可帮助确认分区字段与下推写法。

## 常见策略

- **能用“已有指标字段”就不要重算**：优先使用 ETL 已定义的指标字段，减少口径偏差风险。
- **先过滤再 join**：先在事实表 CTE 中用分区+业务条件过滤，减少 join 扫描量。
- **防止多对多 join 放大**：维表可能存在多版本/多行，先 `row_number()` 取最新或去重后再 join。
- **输出字段要可解释**：最终 select 建议带中文注释/别名（不破坏可执行性前提下），并在 SQL 注释中说明口径假设。
