# 日志与迭代机制

## 目标

把每次问数问答沉淀为可复盘/可训练的样本（good/bad case），并在样本累计到一定数量时自动更新问卷模板。

## 日志位置

日志写在 `assets/logs/qa.jsonl`，该目录已被 `.gitignore` 忽略。

## 自动记录（每次执行都写一条）

每次交付最终 SQL 后，agent 必须自动写入一条日志：

1. 生成 `session-id`（UUID）并贯穿本轮问答
2. 把"用户需求文本"和"最终交付内容"保存为临时文件：`need.txt` / `final.sql`
3. 追加写入日志（默认 `unknown`）：
   ```bash
   python3 scripts/log_qa.py --label unknown --session-id <uuid> --question-file need.txt --answer-file final.sql
   ```

## 收集反馈并更新标签

交付后问用户一个问题："本次结果是否可用？请回复 `good` 或 `bad`，并说明原因。"

收到反馈后更新同一个 session-id 的日志：

```bash
# good case
python3 scripts/log_qa.py --update --label good --session-id <uuid> --feedback "<原因>"

# bad case
python3 scripts/log_qa.py --update --label bad --session-id <uuid> --feedback "<原因>" --issues <issue1,issue2,...>
```

## 常用 issues 标签

- `missing_metric` / `missing_dimension` / `missing_grain` / `missing_time_range` / `missing_filters`
- `missing_output_fields` / `missing_topn_sort` / `missing_dialect_engine` / `missing_dw_path` / `missing_partition_field`
- `mismatch_definition` / `performance_risk`
- `wrong_layer` / `wrong_logic` / `unsupported_function`

## 自动更新问卷模板

当已标注样本累计到 20 条（每新增 20 条再触发一次），自动运行模板更新：

```bash
python3 scripts/optimize_questionnaire.py
```

更新内容写入 `references/问数需求问卷模板.md` 的"数据侧复盘摘要"部分。
